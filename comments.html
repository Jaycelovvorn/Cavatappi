<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="comments.css">
  <style>
    body { padding: 20px; }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { margin-bottom: 18px; }
    .meta-row { display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap }
  </style>
  <title>Comments - Cavatappi</title>
</head>
<body>
  <div class="container" id="comments-app">
    <h1>Comments</h1>

    <!-- Rating (anonymous) -->
    <div class="card" id="rating-card">
      <div class="small muted">Anonymous rating — 1 to 5 stars</div>
      <div id="rating-widget" class="stars" aria-label="Rating widget"></div>
      <div class="small muted" id="rating-summary">Loading…</div>
    </div>

    <!-- New comment form -->
    <div class="card" id="new-comment-card" style="margin-top:16px;">
      <div class="small muted">Leave a comment</div>
      <div class="meta-row">
        <input id="comment-name" placeholder="Your name (required)" required>
      </div>
      <textarea id="comment-text" rows="4" placeholder="Write your comment..." required></textarea>
      <div style="margin-top:8px;">
        <button id="submit-comment">Post Comment</button>
      </div>
    </div>

    <!-- Comments list -->
    <div id="comments-list" style="margin-top:18px;"></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js"></script>

  <script>
  // Firebase config — YOUR ACTUAL CONFIG
  const firebaseConfig = {
    apiKey: "AIzaSyBftfQPCbE3gq6jcRGeKRpdnaMK-oY7qpo",
    authDomain: "cavatappi-28523.firebaseapp.com",
    databaseURL: "https://cavatappi-28523-default-rtdb.firebaseio.com",
    projectId: "cavatappi-28523",
    storageBucket: "cavatappi-28523.firebasestorage.app",
    messagingSenderId: "293468174596",
    appId: "1:293468174596:web:5b9d740393c712e54f3851",
    measurementId: "G-Q67G970XFE"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Comments: Real-time sync via Firebase
  (function(){
    const USER_VOTE_KEY = 'cavatappi_user_vote';

    const commentsListEl = document.getElementById('comments-list');
    const nameInput = document.getElementById('comment-name');
    const textInput = document.getElementById('comment-text');
    const submitBtn = document.getElementById('submit-comment');
    const ratingWidget = document.getElementById('rating-widget');
    const ratingSummary = document.getElementById('rating-summary');

    let comments = [];
    let ratings = [];
    let userVote = null;

    // autosize helpers
    function autosizeTextarea(el){
      if (!el) return;
      el.style.height = 'auto';
      const comp = getComputedStyle(el);
      let max = parseFloat(comp.maxHeight);
      if (isNaN(max) || max === 0) max = window.innerHeight * 0.5;
      const needed = el.scrollHeight;
      const newHeight = Math.min(needed, max);
      el.style.height = newHeight + 'px';
      el.style.overflowY = (needed > max) ? 'auto' : 'hidden';
    }
    function attachAutosize(el){
      if (!el) return null;
      const handler = ()=> autosizeTextarea(el);
      el.addEventListener('input', handler);
      autosizeTextarea(el);
      return ()=> el.removeEventListener('input', handler);
    }

    const mainTA = document.getElementById('comment-text');
    let mainAutosizeCleanup = attachAutosize(mainTA);

    const uid = ()=> 'c' + Date.now().toString(36) + Math.random().toString(36).slice(2,8);
    
    // Load user's vote from localStorage
    function loadUserVote(){
      try {
        const uv = localStorage.getItem(USER_VOTE_KEY);
        if (uv) {
          const v = parseInt(uv, 10);
          if (!Number.isNaN(v) && v >= 1 && v <= 5) userVote = v;
        }
      } catch(e){}
    }
    function saveUserVote(){
      try {
        if (userVote) localStorage.setItem(USER_VOTE_KEY, String(userVote));
        else localStorage.removeItem(USER_VOTE_KEY);
      } catch(e){}
    }

    // Firebase listeners — real-time sync
    db.ref('comments').on('value', (snap) => {
      const data = snap.val();
      comments = data ? Object.values(data) : [];
      renderComments();
    });

    db.ref('ratings').on('value', (snap) => {
      const data = snap.val();
      ratings = data ? Object.values(data) : [];
      renderRating();
    });

    loadUserVote();

    function buildTree(flat){
      const map = new Map();
      flat.forEach(c => map.set(c.id, {...c, children: []}));
      const roots = [];
      map.forEach(node=>{
        if (node.parentId) {
          const p = map.get(node.parentId);
          if (p) p.children.push(node);
          else roots.push(node);
        } else roots.push(node);
      });
      function sortRec(arr){ arr.sort((a,b)=> new Date(a.date) - new Date(b.date)); arr.forEach(n=>sortRec(n.children)); }
      sortRec(roots);
      return roots;
    }

    function renderAll(){
      renderRating();
      renderComments();
    }

    function renderRating(){
      ratingWidget.innerHTML = '';
      for (let i=1;i<=5;i++){
        const s = document.createElement('span');
        s.className = 'star';
        s.dataset.value = i;
        s.innerHTML = '★';
        s.title = i + ' star' + (i>1?'s':'') ;
        s.addEventListener('click', async ()=>{
          if (!userVote) {
            userVote = i; saveUserVote();
            const newRatings = [...ratings, i];
            await db.ref('ratings').set(newRatings.map((r, idx) => ({id: idx, value: r})));
            renderRating(); return;
          }
          if (userVote === i) { alert('You already voted ' + i); return; }
          if (!confirm(`Change from ${userVote} → ${i}?`)) return;
          const idx = ratings.indexOf(userVote);
          if (idx !== -1) ratings.splice(idx, 1);
          userVote = i; saveUserVote();
          const newRatings = [...ratings, i];
          await db.ref('ratings').set(newRatings.map((r, idx2) => ({id: idx2, value: r})));
          renderRating();
        });
        ratingWidget.appendChild(s);
      }
      const existingRemove = document.getElementById('remove-vote-btn');
      if (existingRemove) existingRemove.remove();
      if (userVote) {
        const rem = document.createElement('button');
        rem.id = 'remove-vote-btn';
        rem.className = 'remove-vote';
        rem.textContent = 'Remove my vote';
        rem.addEventListener('click', async ()=>{
          if (!confirm('Remove your vote?')) return;
          const idx = ratings.indexOf(userVote);
          if (idx !== -1) ratings.splice(idx, 1);
          userVote = null; saveUserVote();
          const newRatings = [...ratings];
          await db.ref('ratings').set(newRatings.map((r, idx2) => ({id: idx2, value: r})));
          renderRating();
        });
        ratingWidget.parentNode.appendChild(rem);
      }
      const count = ratings.length;
      const avg = count ? (ratings.reduce((a,b)=>a+b,0)/count) : 0;
      const me = userVote ? `Your vote: ${userVote} — ` : '';
      ratingSummary.textContent = count ? `${me}Average ${avg.toFixed(2)} / 5 — ${count} vote${count>1?'s':''}` : `${me}No ratings yet!`;
      const rounded = Math.round(avg);
      Array.from(ratingWidget.children).forEach((el, idx)=>{
        el.classList.toggle('filled', (idx+1) <= rounded);
      });
    }

    function renderComments(){
      commentsListEl.innerHTML = '';
      const tree = buildTree(comments);
      if (!tree.length) { commentsListEl.innerHTML = '<div class="small muted">No comments yet.</div>'; return; }
      const wrapper = document.createElement('div'); wrapper.className = 'comment-list';
      tree.forEach(node => wrapper.appendChild(renderCommentNode(node, 0)));
      commentsListEl.appendChild(wrapper);
    }

    function renderCommentNode(node, depth){
      const el = document.createElement('div'); el.className = 'comment'; if (depth>0) el.classList.add('reply');
      el.innerHTML = `
        <div class="comment-head">
          <strong class="comment-name"></strong>
          <span class="comment-date small muted"></span>
        </div>
        <div class="comment-body"></div>
        <div class="comment-actions small muted">
          <button class="reply-btn">Reply</button>
        </div>
        <div class="replies"></div>
      `;
      el.querySelector('.comment-name').textContent = node.name;
      el.querySelector('.comment-date').textContent = ' • ' + (new Date(node.date)).toLocaleString();
      el.querySelector('.comment-body').textContent = node.text;
      const replyBtn = el.querySelector('.reply-btn');
      replyBtn.addEventListener('click', ()=> openReplyForm(el.querySelector('.replies'), node.id));
      const childrenContainer = el.querySelector('.replies');
      node.children.forEach(child => childrenContainer.appendChild(renderCommentNode(child, depth+1)));
      return el;
    }

    function openReplyForm(containerEl, parentId){
      if (containerEl.querySelector('.reply-form')) return;
      const form = document.createElement('div'); form.className = 'reply-form card';
      form.innerHTML = `
        <input class="reply-name" placeholder="Your name (required)" required>
        <textarea class="reply-text" rows="3" placeholder="Write a reply..." required></textarea>
        <div style="text-align:right; margin-top:6px;">
          <button class="reply-cancel">Cancel</button>
          <button class="reply-submit">Post Reply</button>
        </div>
      `;
      containerEl.prepend(form);
      const ta = form.querySelector('.reply-text');
      const cleanup = attachAutosize(ta);
      form.querySelector('.reply-cancel').addEventListener('click', ()=> { cleanup && cleanup(); form.remove(); });
      form.querySelector('.reply-submit').addEventListener('click', async ()=>{
        const rName = form.querySelector('.reply-name').value.trim();
        const rText = ta.value.trim();
        if (!rName || !rText) { alert('Name and reply required'); return; }
        const comment = { id: uid(), parentId: parentId, name: rName, text: rText, date: (new Date()).toISOString() };
        const newComments = [...comments, comment];
        await db.ref('comments').set(newComments.reduce((acc, c, idx) => ({...acc, [idx]: c}), {}));
        cleanup && cleanup(); form.remove();
      });
    }

    submitBtn.addEventListener('click', async ()=>{
      const n = nameInput.value.trim();
      const t = textInput.value.trim();
      if (!n || !t) { alert('Name and comment required'); return; }
      const c = { id: uid(), parentId: null, name: n, text: t, date: (new Date()).toISOString() };
      const newComments = [...comments, c];
      await db.ref('comments').set(newComments.reduce((acc, cm, idx) => ({...acc, [idx]: cm}), {}));
      nameInput.value = ''; textInput.value = '';
      if (mainAutosizeCleanup) mainAutosizeCleanup();
      mainTA.style.height = '';
      mainAutosizeCleanup = attachAutosize(mainTA);
    });

    window.__cavatappi_comments = { getComments: ()=>comments, getRatings: ()=>ratings, getUserVote: ()=>userVote };
  })();
  </script>
</body>
</html>
