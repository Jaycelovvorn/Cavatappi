<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="comments.css">
  <style>
    body { padding: 20px; }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { margin-bottom: 18px; }
    .meta-row { display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap }
  </style>
  <title>Comments - Cavatappi</title>
</head>
<body>
  <div class="container" id="comments-app">
    <h1>Comments</h1>

    <!-- Rating (anonymous) -->
    <div class="card" id="rating-card">
      <div class="small muted">Anonymous rating — 1 to 5 stars</div>
      <div id="rating-widget" class="stars" aria-label="Rating widget"></div>
      <div class="small muted" id="rating-summary">Loading…</div>
    </div>

    <!-- New comment form -->
    <div class="card" id="new-comment-card" style="margin-top:16px;">
      <div class="small muted">Leave a comment</div>
      <div class="meta-row">
        <input id="comment-name" placeholder="Your name (required)" required>
      </div>
      <textarea id="comment-text" rows="4" placeholder="Write your comment..." required></textarea>
      <div style="margin-top:8px;">
        <button id="submit-comment">Post Comment</button>
      </div>
    </div>

    <!-- Comments list -->
    <div id="comments-list" style="margin-top:18px;"></div>
  </div>

  <script>
  // Comments: localStorage auto-save. Fetch comments.json for initial display.
  (function(){
    const STORAGE_KEY = 'cavatappi_comments';
    const RATINGS_KEY = 'cavatappi_ratings';
    const USER_VOTE_KEY = 'cavatappi_user_vote';

    const commentsListEl = document.getElementById('comments-list');
    const nameInput = document.getElementById('comment-name');
    const textInput = document.getElementById('comment-text');
    const submitBtn = document.getElementById('submit-comment');
    const ratingWidget = document.getElementById('rating-widget');
    const ratingSummary = document.getElementById('rating-summary');

    let comments = [];
    let ratings = [];
    let userVote = null;

    // autosize helpers
    function autosizeTextarea(el){
      if (!el) return;
      el.style.height = 'auto';
      const comp = getComputedStyle(el);
      let max = parseFloat(comp.maxHeight);
      if (isNaN(max) || max === 0) max = window.innerHeight * 0.5;
      const needed = el.scrollHeight;
      const newHeight = Math.min(needed, max);
      el.style.height = newHeight + 'px';
      el.style.overflowY = (needed > max) ? 'auto' : 'hidden';
    }
    function attachAutosize(el){
      if (!el) return null;
      const handler = ()=> autosizeTextarea(el);
      el.addEventListener('input', handler);
      autosizeTextarea(el);
      return ()=> el.removeEventListener('input', handler);
    }

    const mainTA = document.getElementById('comment-text');
    let mainAutosizeCleanup = attachAutosize(mainTA);

    const uid = ()=> 'c' + Date.now().toString(36) + Math.random().toString(36).slice(2,8);
    
    function saveLocal(){
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(comments));
        localStorage.setItem(RATINGS_KEY, JSON.stringify(ratings));
        if (userVote) localStorage.setItem(USER_VOTE_KEY, String(userVote)); 
        else localStorage.removeItem(USER_VOTE_KEY);
      } catch(e){}
    }
    
    function loadLocal(){
      try {
        const c = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null');
        const r = JSON.parse(localStorage.getItem(RATINGS_KEY) || 'null');
        const uv = localStorage.getItem(USER_VOTE_KEY);
        if (Array.isArray(c)) comments = c;
        if (Array.isArray(r)) ratings = r;
        if (uv) {
          const v = parseInt(uv,10);
          if (!Number.isNaN(v) && v>=1 && v<=5) userVote = v;
        }
      } catch(e){}
    }

    // Load comments.json, then overlay localStorage
    fetch('comments.json')
      .then(r => r.ok ? r.json() : Promise.reject('no json'))
      .then(data => {
        if (Array.isArray(data.comments)) comments = data.comments;
        if (Array.isArray(data.ratings)) ratings = data.ratings;
        loadLocal(); // overlay localStorage on top
        renderAll();
      })
      .catch(() => {
        loadLocal(); // fallback to localStorage only
        renderAll();
      });

    function buildTree(flat){
      const map = new Map();
      flat.forEach(c => map.set(c.id, {...c, children: []}));
      const roots = [];
      map.forEach(node=>{
        if (node.parentId) {
          const p = map.get(node.parentId);
          if (p) p.children.push(node);
          else roots.push(node);
        } else roots.push(node);
      });
      function sortRec(arr){ arr.sort((a,b)=> new Date(a.date) - new Date(b.date)); arr.forEach(n=>sortRec(n.children)); }
      sortRec(roots);
      return roots;
    }

    function renderAll(){
      renderRating();
      renderComments();
    }

    function renderRating(){
      ratingWidget.innerHTML = '';
      for (let i=1;i<=5;i++){
        const s = document.createElement('span');
        s.className = 'star';
        s.dataset.value = i;
        s.innerHTML = '★';
        s.title = i + ' star' + (i>1?'s':'') ;
        s.addEventListener('click', ()=>{
          if (!userVote) {
            ratings.push(i); userVote = i; saveLocal(); renderRating(); return;
          }
          if (userVote === i) { alert('You already voted ' + i + ' star' + (i>1?'s':'') + '.'); return; }
          if (!confirm(`Change your vote from ${userVote} → ${i}?`)) return;
          const idx = ratings.indexOf(userVote); if (idx !== -1) ratings.splice(idx,1);
          ratings.push(i); userVote = i; saveLocal(); renderRating();
        });
        ratingWidget.appendChild(s);
      }
      const existingRemove = document.getElementById('remove-vote-btn');
      if (existingRemove) existingRemove.remove();
      if (userVote) {
        const rem = document.createElement('button');
        rem.id = 'remove-vote-btn';
        rem.className = 'remove-vote';
        rem.textContent = 'Remove my vote';
        rem.title = 'Remove your vote so you can vote again';
        rem.addEventListener('click', ()=>{
          if (!confirm('Remove your vote?')) return;
          const idx = ratings.indexOf(userVote);
          if (idx !== -1) ratings.splice(idx,1);
          userVote = null; saveLocal(); renderRating();
        });
        ratingWidget.parentNode.appendChild(rem);
      }
      const count = ratings.length;
      const avg = count ? (ratings.reduce((a,b)=>a+b,0)/count) : 0;
      const me = userVote ? `Your vote: ${userVote} — ` : '';
      ratingSummary.textContent = count ? `${me}Average ${avg.toFixed(2)} / 5 — ${count} vote${count>1?'s':''}` : `${me}No ratings yet — be the first!`;
      const rounded = Math.round(avg);
      Array.from(ratingWidget.children).forEach((el, idx)=>{
        el.classList.toggle('filled', (idx+1) <= rounded);
      });
    }

    function renderComments(){
      commentsListEl.innerHTML = '';
      const tree = buildTree(comments);
      if (!tree.length) { commentsListEl.innerHTML = '<div class="small muted">No comments yet.</div>'; return; }
      const wrapper = document.createElement('div'); wrapper.className = 'comment-list';
      tree.forEach(node => wrapper.appendChild(renderCommentNode(node, 0)));
      commentsListEl.appendChild(wrapper);
    }

    function renderCommentNode(node, depth){
      const el = document.createElement('div'); el.className = 'comment'; if (depth>0) el.classList.add('reply');
      el.innerHTML = `
        <div class="comment-head">
          <strong class="comment-name"></strong>
          <span class="comment-date small muted"></span>
        </div>
        <div class="comment-body"></div>
        <div class="comment-actions small muted">
          <button class="reply-btn">Reply</button>
        </div>
        <div class="replies"></div>
      `;
      el.querySelector('.comment-name').textContent = node.name;
      el.querySelector('.comment-date').textContent = ' • ' + (new Date(node.date)).toLocaleString();
      el.querySelector('.comment-body').textContent = node.text;
      const replyBtn = el.querySelector('.reply-btn');
      replyBtn.addEventListener('click', ()=> openReplyForm(el.querySelector('.replies'), node.id));
      const childrenContainer = el.querySelector('.replies');
      node.children.forEach(child => childrenContainer.appendChild(renderCommentNode(child, depth+1)));
      return el;
    }

    function openReplyForm(containerEl, parentId){
      if (containerEl.querySelector('.reply-form')) return;
      const form = document.createElement('div'); form.className = 'reply-form card';
      form.innerHTML = `
        <input class="reply-name" placeholder="Your name (required)" required>
        <textarea class="reply-text" rows="3" placeholder="Write a reply..." required></textarea>
        <div style="text-align:right; margin-top:6px;">
          <button class="reply-cancel">Cancel</button>
          <button class="reply-submit">Post Reply</button>
        </div>
      `;
      containerEl.prepend(form);
      const ta = form.querySelector('.reply-text');
      const cleanup = attachAutosize(ta);
      form.querySelector('.reply-cancel').addEventListener('click', ()=> { cleanup && cleanup(); form.remove(); });
      form.querySelector('.reply-submit').addEventListener('click', ()=>{
        const rName = form.querySelector('.reply-name').value.trim();
        const rText = ta.value.trim();
        if (!rName || !rText) { alert('Name and reply are required'); return; }
        const comment = { id: uid(), parentId: parentId, name: rName, text: rText, date: (new Date()).toISOString() };
        comments.push(comment); saveLocal(); cleanup && cleanup(); renderComments();
      });
    }

    submitBtn.addEventListener('click', ()=>{
      const n = nameInput.value.trim(); 
      const t = textInput.value.trim();
      if (!n || !t) { alert('Please enter your name and a comment.'); return; }
      const c = { id: uid(), parentId: null, name: n, text: t, date: (new Date()).toISOString() };
      comments.push(c); nameInput.value = ''; textInput.value = '';
      if (mainAutosizeCleanup) mainAutosizeCleanup();
      mainTA.style.height = ''; 
      mainAutosizeCleanup = attachAutosize(mainTA);
      saveLocal(); renderComments();
    });

    setTimeout(() => renderAll(), 50);

    window.__cavatappi_comments = { getComments: ()=>comments, getRatings: ()=>ratings, getUserVote: ()=>userVote };
  })();
  </script>
</body>
</html>
